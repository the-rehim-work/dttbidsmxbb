@{
    ViewData["Title"] = "Audit loqları";
}
<style>
    .bg-gray {
        background-color: #adb5bd !important;
    }

    .bg-purple {
        background-color: #6f42c1 !important;
    }

    .bg-orange {
        background-color: #fd7e14 !important;
    }

    .bg-teal {
        background-color: #20c997 !important;
    }

    .bg-cyan {
        background-color: #0dcaf0 !important;
    }

    .bg-indigo {
        background-color: #6610f2 !important;
    }
</style>

<form id="__tokenForm" method="post" style="display:none;">
    @Html.AntiForgeryToken()
</form>

<div class="container-fluid">
    <h4 class="mb-4">Audit loqları</h4>

    <div class="card shadow-sm border-0">
        <div class="card-body position-relative" style="min-height: 400px;">
            <table id="logsTable" class="table table-hover align-middle">
                <thead>
                    <tr>
                        <th>İstifadəçi</th>
                        <th>Əməliyyat</th>
                        <th>Cədvəl</th>
                        <th>Qeyd ID</th>
                        <th>Tarix</th>
                        <th class="text-center" data-orderable="false">Ətraflı</th>
                    </tr>
                </thead>
            </table>
        </div>
    </div>
</div>

<div class="modal fade" id="detailModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Dəyişiklik detalları</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row g-3">
                    <div class="col-md-6">
                        <h6 class="text-muted mb-2">Köhnə dəyərlər</h6>
                        <pre id="oldValues" class="bg-light p-3 rounded border" style="max-height: 450px; overflow: auto; font-size: 0.875rem; margin: 0;"></pre>
                    </div>
                    <div class="col-md-6">
                        <h6 class="text-muted mb-2">Yeni dəyərlər</h6>
                        <pre id="newValues" class="bg-light p-3 rounded border" style="max-height: 450px; overflow: auto; font-size: 0.875rem; margin: 0;"></pre>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="~/js/logs.js"></script>
    <script>
        $(function () {
            const actionStyles = [
                { keywords: ['Əlavə'], badge: 'bg-success text-white' },
                { keywords: ['Redaktə'], badge: 'bg-primary text-white' },
                { keywords: ['Bərpa'], badge: 'bg-teal text-white' },
                { keywords: ['Silindi'], badge: 'bg-danger text-white' },
                { keywords: ['İxrac'], badge: 'bg-cyan text-dark' },
                { keywords: ['İdxal'], badge: 'bg-indigo text-white' },
                { keywords: ['Ehtiyat'], badge: 'bg-warning text-dark' },
                { keywords: ['Login'], badge: 'bg-dark text-white' },
                { keywords: ['Logout'], badge: 'bg-gray text-dark' },
                { keywords: ['Bloklandı'], badge: 'bg-purple text-white' },
                { keywords: ['Xəta'], badge: 'bg-orange text-white' }
            ];

            var table = window.dttbidsmxbb.initLogsTable({
                url: '@Url.Action("LoadAuditLogs", "Logs")',
                defaultOrder: [[4, 'desc']],
                columns: [
                    { data: 'userFullName', className: 'fw-medium' },
                    {
                        data: 'action',
                        render: function (data) {
                            let style = 'bg-gray text-dark';
                            for (const rule of actionStyles) {
                                if (rule.keywords.some(k => data.includes(k))) {
                                    style = rule.badge;
                                    break;
                                }
                            }
                            return `<span class="badge ${style} px-3 py-2">${data}</span>`;
                        }
                    },
                    { data: 'entityName', className: 'font-monospace text-muted small' },
                    { data: 'entityId', className: 'text-center' },
                    { data: 'timestamp', render: window.dttbidsmxbb.formatTimestamp },
                    {
                        data: null,
                        orderable: false,
                        className: 'text-center',
                        render: function (data) {
                            if (!data.oldValues && !data.newValues) return '—';
                            return '<button class="btn btn-sm btn-outline-primary detail-btn">Bax</button>';
                        }
                    }
                ]
            });

            $('#logsTable').on('click', '.detail-btn', function () {
                var rowData = table.row($(this).closest('tr')).data();
                if (!rowData) return;
                $('#oldValues').text(window.dttbidsmxbb.formatJson(rowData.oldValues));
                $('#newValues').text(window.dttbidsmxbb.formatJson(rowData.newValues));
                new bootstrap.Modal('#detailModal').show();
            });
        });
    </script>
}
