@using System.Security.Claims
@using Microsoft.AspNetCore.Identity
@inject SignInManager<AppUser> SignInManager
@inject UserManager<AppUser> UserManager

@{
    var controllerName = ViewContext.RouteData.Values["controller"]?.ToString() ?? "";
    var actionName = ViewContext.RouteData.Values["action"]?.ToString() ?? "";

    string ActiveClass(string controller, string? action = null)
    {
        if (action != null)
            return controllerName == controller && actionName == action ? "active-page" : "";
        return controllerName == controller ? "active-page" : "";
    }
}

<!DOCTYPE html>
<html lang="az">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dövlət Sirrinin Mühafizəsi Xidməti Buraxılışlar Bazası</title>

    <link rel="stylesheet" href="~/lib/bootstrap/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="~/lib/datatables/datatables.min.css" />
    <link href="~/lib/datatables/fixedcolumns.datatables.min.css" rel="stylesheet" />
    <link href="~/lib/select2/select2.min.css" rel="stylesheet" />
    <link href="~/lib/flatpickr/flatpickr.min.css" rel="stylesheet" />
    <link href="~/lib/flatpickr/airbnb.css" rel="stylesheet" />
    <link rel="stylesheet" href="~/css/site.css" asp-append-version="true" />
    <script src="~/lib/jquery/dist/jquery.min.js"></script>
</head>
<body>

    @if (!controllerName.Contains("Log") && !controllerName.Contains("User") && !controllerName.Contains("Home") && actionName.Contains("Index"))
    {
        <div id="tableLoader" style="
                                    display:none;
                                    position:fixed;
                                    top:0; left:0;
                                    width:100%; height:100%;
                                    background:rgba(255,255,255,1);
                                    z-index:9999;
                                    display:flex;
                                    align-items:center;
                                    justify-content:center;
                                    flex-direction:column;
                                    font-size:1.2em;">
            <div class="spinner-border text-primary mb-3" role="status" style="width:3rem; height:3rem;">
                <span class="visually-hidden">Loading...</span>
            </div>
            <div>Yüklənir...</div>
        </div>
    }

    <div class="d-flex">
        <nav id="sidebarMenu" class="d-flex flex-column justify-content-start">
            <div class="text-center py-3 logo-wrap border-bottom">
                <a asp-controller="Home" asp-action="Index" class="d-block">
                    <img src="~/assets/500px-azerbaijan_mod_badge.svg.png" alt="Logo" />
                </a>
            </div>

            <div class="sidebar-title">
                Dövlət Sirrinin Mühafizəsi Xidməti Buraxılışlar Bazası
            </div>

            <div class="text-center py-2 user-info">
                @if (User?.Identity?.IsAuthenticated ?? false)
                {
                    var me = await UserManager.GetUserAsync(User);
                    <div class="user-name">İstifadəçi: @(me?.FullName ?? User.Identity?.Name)</div>
                    <div class="user-role">
                        Rol:
                        @{
                            var roles = User.Claims
                            .Where(c => c.Type == ClaimTypes.Role)
                            .Select(c => char.ToUpper(c.Value[0]) + c.Value[1..]);
                        }
                        @string.Join(", ", roles)
                    </div>
                }
            </div>

            <ul class="nav px-2 sidebar overflow-auto">
                <li class="nav-item w-100">
                    <a class="nav-link @ActiveClass("Home")" asp-controller="Home" asp-action="Index">
                        <img src="~/assets/dashboard.svg" />İdarəetmə paneli
                    </a>
                </li>
                <li class="nav-item w-100">
                    <a class="nav-link @ActiveClass("Informations")" asp-controller="Informations" asp-action="Index">
                        <img src="~/assets/info.svg" />Məlumatlar
                    </a>
                </li>

                <li class="nav-item w-100 mt-2">
                    <small class="text-muted px-3 text-uppercase" style="font-size: 0.7rem;">Arayış</small>
                </li>
                <li class="nav-item w-100">
                    <a class="nav-link @ActiveClass("Lookups", "MilitaryRanks")" asp-controller="Lookups" asp-action="MilitaryRanks">
                        <img src="~/assets/social_media.svg" />Hərbi rütbələr
                    </a>
                </li>
                <li class="nav-item w-100">
                    <a class="nav-link @ActiveClass("Lookups", "MilitaryBases")" asp-controller="Lookups" asp-action="MilitaryBases">
                        <img src="~/assets/social_media.svg" />Hərbi hissələr
                    </a>
                </li>
                <li class="nav-item w-100">
                    <a class="nav-link @ActiveClass("Lookups", "Executors")" asp-controller="Lookups" asp-action="Executors">
                        <img src="~/assets/social_media.svg" />İcraçılar
                    </a>
                </li>

                @if (SignInManager.IsSignedIn(User) && User.IsInRole("Admin"))
                {
                    <li class="nav-item w-100 mt-2">
                        <small class="text-muted px-3 text-uppercase" style="font-size: 0.7rem;">Admin</small>
                    </li>
                    <li class="nav-item w-100">
                        <a class="nav-link @ActiveClass("Users")" asp-controller="Users" asp-action="Index">
                            <img src="~/assets/users.svg" />İstifadəçilər
                        </a>
                    </li>
                    <li class="nav-item w-100">
                        <a class="nav-link @ActiveClass("Logs", "AuditLogs")" asp-controller="Logs" asp-action="AuditLogs">
                            <img src="~/assets/logs.svg" />Audit loqları
                        </a>
                    </li>
                    <li class="nav-item w-100">
                        <a class="nav-link @ActiveClass("Logs", "AuthLogs")" asp-controller="Logs" asp-action="AuthLogs">
                            <img src="~/assets/logs.svg" />Giriş loqları
                        </a>
                    </li>
                    <li class="nav-item w-100">
                        <a class="nav-link @ActiveClass("Logs", "EventLogs")" asp-controller="Logs" asp-action="EventLogs">
                            <img src="~/assets/logs.svg" />Hərəkət loqları
                        </a>
                    </li>
                }
            </ul>

            <div class="p-3 border-top mt-auto">
                @if (User?.Identity?.IsAuthenticated ?? false)
                {
                    <button type="button" class="btn btn-outline-primary w-100 mb-2"
                            data-bs-toggle="modal" data-bs-target="#changeMyPasswordModal">
                        <img src="~/assets/change_password.svg" class="authimg" style="filter: invert(0);" />Şifrəni dəyiş
                    </button>
                }
                <form id="logoutForm" method="post" asp-controller="Auth" asp-action="Logout">
                    @Html.AntiForgeryToken()
                    <button type="submit" class="btn btn-danger w-100">
                        <img src="~/assets/logout.svg" class="authimg" />Çıxış
                    </button>
                </form>
            </div>
        </nav>

        <div class="flex-grow-1 d-flex flex-column content-area">
            <main class="container-fluid py-4 overflow-auto" style="flex: 1;">
                @RenderBody()
            </main>

            <footer class="text-center py-3 text-muted" style="font-size: 0.8rem;">
                © 2025 — Dövlət Sirrinin Mühafizəsi Xidməti Buraxılışlar Bazası
            </footer>
        </div>
    </div>

    <div class="modal fade" id="changeMyPasswordModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Şifrəni dəyiş</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Bağla"></button>
                </div>
                <div class="modal-body" id="changeMyPasswordBody"></div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Ləğv et</button>
                    <button type="button" id="saveMyPasswordBtn" class="btn btn-primary">Yadda saxla</button>
                </div>
            </div>
        </div>
    </div>

    <div id="toastContainer" class="toast-container position-fixed bottom-0 end-0 p-3" style="z-index: 1080;"></div>

    <template id="toastTemplate">
        <div class="toast" role="alert" data-bs-autohide="true" data-bs-delay="4000">
            <div class="toast-header">
                <span class="toast-icon me-2"></span>
                <strong class="me-auto toast-title"></strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
            </div>
            <div class="toast-body"></div>
        </div>
    </template>

    <script src="~/lib/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
    <script src="~/lib/flatpickr/flatpickr.min.js"></script>
    <script src="~/lib/flatpickr/flatpickr_az.js"></script>
    <script src="~/lib/datatables/datatables.min.js"></script>
    <script src="~/lib/datatables/datetime-moment.js"></script>
    <script src="~/lib/select2/select2.min.js"></script>
    <script src="~/lib/chartjs/chart.umd.min.js"></script>
    <script src="~/js/site.js" asp-append-version="true"></script>
    @await RenderSectionAsync("Scripts", required: false)

    @if (TempData["ToastType"] != null)
    {
        <script>
            document.addEventListener('DOMContentLoaded', function() {
                window.dttbidsmxbb.toast('@TempData["ToastType"]', '@TempData["ToastMessage"]');
            });
        </script>
    }
</body>
</html>
